<!DOCTYPE HTML>
<HTML lang="en">
	<head>
		<title>My Calendar</title>
		<meta charset="UTF-8">

		<link rel="stylesheet" href="fullcalendar/core/main.css" />
		<link rel="stylesheet" href="fullcalendar/daygrid/main.css" />
		<link rel="stylesheet" href="fullcalendar/timegrid/main.css" />

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

		<script src="fullcalendar/core/main.js"></script>
		<script src="fullcalendar/daygrid/main.js"></script>
		<script src="fullcalendar/timegrid/main.js"></script>
		<script src="fullcalendar/interaction/main.js"></script>

		<script>
			document.addEventListener("DOMContentLoaded", function() {
				var Calendar = FullCalendar.Calendar;
				var Draggable = FullCalendarInteraction.Draggable;

				var containerE1 = document.getElementById("external-events");
				var calendarE1 = document.getElementById("calendar");
				var checkbox = document.getElementById("drop-remove");

				new Draggable(containerE1, {
					itemSelector: ".fc-event",
					eventData: function(eventE1) {
						return {
							title: eventE1.innerText
						};
					}
				});

				var calendar = new Calendar(calendarE1, {
					plugins: [ "interaction", "dayGrid", "timeGrid" ],
					defaultView: "timeGridWeek",
					header: {
						left: "prev,next today addSaveButton,addLoadButton",
						center: "title",
						right: "dayGridMonth,timeGridWeek,timeGridDay"
					},
					customButtons: {
						addSaveButton: {
							text: 'Save',
							click: function() {
								(async function loop() {
									var ev = calendar.getEvents();
									var i;
									var lIndex = ev.length - 1;
									for(i = 0; i < ev.length; i++) {
										var t = ev[i].title;
										var s = ev[i].start;
										var e = ev[i].end;
										var st = s.toISOString();
										var en = e.toISOString();
										await new Promise(resolve => setTimeout(resolve, Math.random() * 200));
										$.ajax({
											url: '/getEvents',
											type: 'POST',
											data: {
												title: t,
												start: st,
												end: en,
												index: i,
												lastIndex: lIndex
											}
										})
									}
								})();
							}
						},
						addLoadButton: {
							text: 'Load',
							click: function() {
								//Removes all events from calendar
								(async function loop() {
									var events = calendar.getEvents();
									var evSources = calendar.getEventSources();
										for(var i = 0; i < events.length; i++) {
											events[i].remove();
											await new Promise(resolve => setTimeout(resolve, Math.random() * 200));
										}
									evSources.remove();
								})();

								$.ajax({
									url: '/loadEvents',
									type: 'POST',
									data: { "data" : "check" },
									success: function(data) {
										calendar.addEventSource(eval(data));
										calendar.refetch();
									}
								})
							}
						}
					},
					selectable: true,
					selectMirror: true,
					editable: true,
					droppable: true,

					//events: "/assets/sampleEventCalendar.json",

					select: function(eventE) {
						var title = prompt('Event title: ');
						if(title) {
							calendar.addEvent({
								title: title,
								start: eventE.start,
								end: eventE.end,
								allDay: eventE.allDay
							})
						}
						calendar.unselect()
					}
				});

				calendar.on('eventClick', function(eventE) {
					var del = confirm("Delete this event?\nEvent Name: " + eventE.event.title + "\nStart time: " + eventE.event.start + "\nEnd  time: " + eventE.event.end);
					if(del) {
						var del2 = confirm("Are you sure you want to delete: " + eventE.event.title + "?");
						if(del2) {
							eventE.event.remove();
						}
					}
					calendar.unselect()
				});

				calendar.render();
			});
		</script>

		<style>
			html, body {
				margin: 0;
				padding: 0;
				font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
				font-size: 14px;
			}

			#external-events {
				position: fixed;
				z-index: 2;
				top: 20px;
				left: 20px;
				width: 150px;
				padding: 0 10px;
				border: 1px solid #ccc;
				background: #eee;
			}

			#external-events .fc-event {
				margin: 1em 0;
				cursor: move;
			}

			#calendar-container {
				position: relative;
				z-index: 1;
				margin-left: 200px;
			}

			#calendar {
				max-width: 900px;
				margin: 20px auto;
			}
		</style>
	</head>
	<body>
		<div id="external-events">
			<p>
				<p><a href="index.html">Home</a><br><a href="about-us.html">About Us</a><br><a href="login.html">Login</a><br><a href="register.html">Register</a><br></p>
				Drag predefined events onto calendar or click on blank spaces to add custom events.
				<br><br>
				Click save button at the top of the page to save your calendar.
				<br><br>
				<strong>Draggable Events</strong>
			</p>
			<div style = "background-color:orange;" class="fc-event">Work</div>
			<div class="fc-event">School</div>
		</div>
		<div id="calendar-container">
			<div id="calendar"></div>
		</div>
	</body>
</HTML>
